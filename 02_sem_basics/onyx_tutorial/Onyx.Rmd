---
title: "Onyx example code"
author: "Nate Hall (adapted with permission from Benjamin N. Johnson)"
date: "Jan 15, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

##change below to the current working directory on your machine

# basedir <- file.path("~/Box Sync/SPR19_SEM/onyx_tutorial/") #iMac
basedir <- file.path("~/Box/psy-597-sem-sp2019/02_sem_basics/onyx_tutorial/") #mbp
setwd(basedir)

library(dplyr)
library(lavaan)
library(jtools)

####not that the above can be accomplished using 
#pacman::p_load(dplyr, lavaan, jtools)
```


#Simple intro: Single Predictor regression using the `lm()` function on sample data from Onyx:

Start with loading data from the example: \n

```{r onyx single predictor}
simple.dat <- read.csv("simple_regression_data.csv", header = TRUE, sep = "\t")
str(simple.dat)
simple.lm <- lm(Y_c~X_c, data = simple.dat)
summ(simple.lm)
summary(simple.lm)
```
\n
Now, let's load the model we generated in Onyx:

```{r lavaan single predictor}
source("single_predictor_data.R")

###contains the lavaan script:
#  model<-"
# ! regressions 
#    Child_IQ ~ Parent_IQ__Child_IQ*Parent_IQ
# ! residuals, variances and covariances
#    Parent_IQ ~~ VAR_Parent_IQ*Parent_IQ
#    Child_IQ ~~ VAR_Child_IQ*Child_IQ
# ! observed means
#    Parent_IQ~1;
#    Child_IQ~1;
# ";

```

#Now, let's expand to multiple regression:

```{r example}
data(mtcars)
# write.csv(mtcars, file = "mtcars.csv")

lm(mpg~hp+wt+gear,mtcars) %>% summ()
lm(mpg~hp+wt+gear,mtcars) %>% vcov()

```


```{r onyx}
#
# This model specification was automatically generated by Onyx
#

 model<-"
! regressions 
   mpg ~ gear__mpg*gear
   mpg ~ wt__mpg*wt
   mpg ~ hp__mpg*hp
! residuals, variances and covariances
   mpg ~~ VAR_mpg*mpg
   hp ~~ VAR_hp*hp
   wt ~~ VAR_wt*wt
   gear ~~ VAR_gear*gear
   wt ~~ COV_wt_hp*hp
   gear ~~ COV_gear_wt*wt
   gear ~~ COV_gear_hp*hp
! observed means
   mpg~1;
   hp~1;
   wt~1;
   gear~1;
";


result<-lavaan(model, data=mtcars, fixed.x=FALSE, missing="FIML");
summary(result, fit.measures=TRUE);
inspect(result, "list")

```

#running the same model with much less input 

```{r onyx_cf}
model2<-'
mpg~hp+wt+gear
'
result2<-cfa(model2,data=mtcars, fixed.x = F,missing="FIML")
summary(result2,fit.measures=T)
inspect(result2,"list")
```

#Fitting a simple single-factor CFA:

```{r onyx_cfa}

cfa_dat<-read.csv("CFA_data.csv",head=T)
#
# This model specification was automatically generated by Onyx:
 model<-"
! regressions 
   x1=~1.0*X1   ##fixing loadings makes fit worse but more on this later
   x1=~1.0*X2
   x1=~1.0*X3
! residuals, variances and covariances
   X1 ~~ VAR_X1*X1
   X2 ~~ VAR_X2*X2
   X3 ~~ VAR_X3*X3
   x1 ~~ VAR_x1*x1
! observed means
   X1~1;
   X2~1;
   X3~1;
";
result<-lavaan(model, data=cfa_dat, fixed.x=FALSE, missing="FIML");
summary(result, fit.measures=TRUE);


 model_free<-"
! regressions 
   x1=~1.0*X1
   x1=~x1__X2*X2
   x1=~x1__X3*X3
! residuals, variances and covariances
   X1 ~~ VAR_X1*X1
   X2 ~~ VAR_X2*X2
   X3 ~~ VAR_X3*X3
   x1 ~~ VAR_x1*x1
! observed means
   X1~1;
   X2~1;
   X3~1;
";
result_free<-lavaan(model_free, data=cfa_dat, fixed.x=FALSE, missing="FIML");
summary(result, fit.measures=TRUE);

inspect(result_free, "std") #gives loadings (see standardized estimates on word doc)
```


